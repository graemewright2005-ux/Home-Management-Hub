<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meals & Recipes | Home Hub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --gradient: linear-gradient(135deg, #a4befe 0%, #f0b7a4 100%);
            --bg: #f7f9fc;
            --card: #fff;
            --text: #17263a;
            --text-dim: #6a7fa7;
            --border: #e3e6f2;
            --accent: #e37b38;
            --btn: #f4b586;
            --btn-hover: #e37b38;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .nav { background: var(--card); border-bottom: 1px solid var(--border); padding: 1rem 1.5rem; }
        .nav-content { max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;}
        .nav-brand { font-size: 1.5rem; font-weight: 800; background: var(--gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent;}
        .nav-menu { display: flex; gap: 0.5rem; list-style: none;}
        .nav-menu a { padding:0.6rem 1.2rem; border-radius:8px; text-decoration:none; color:var(--text-dim); font-weight:600; font-size:0.95rem;}
        .nav-menu a:hover { background: rgba(102,126,234,0.12); color:var(--primary);}
        .nav-menu a.active { background: var(--gradient); color:#fff;}
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 1.5rem;}
        h1 { font-size:2rem; background:var(--gradient); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin: 0;}
        .top-controls { display: flex; gap: 1.1em; align-items: center; margin-bottom: 1.7em; flex-wrap: wrap;}
        .btn, .btn-primary {
            padding:0.8em 1.3em;
            border-radius:8px;
            font-weight:600;
            border:none;
            background: var(--gradient);
            color:#fff;
            font-size:1em;
            transition: background 0.19s;
            cursor:pointer;
        }
        .btn:hover { background: linear-gradient(120deg, var(--btn-hover) 0%, #f1d8ff 100%); }
        .filters-bar {display: flex; flex-wrap: wrap; gap: 1.3em; margin-bottom: 1.9em; align-items:center;}
        .filters-bar select {
            min-width:120px; max-width:200px;
            border-radius:8px; border:1.5px solid var(--border); background:#fdf6ed;
            color:var(--text); font-size:1em; padding:0.62em 1em; box-shadow:0 1px 3px #e3eaf855;
        }
        .filters-bar label {color:var(--text-dim); font-size:0.99em;}
        .grid {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-bottom:2rem;
            align-items: stretch;
        }
        .card {
            background: var(--card);
            border: 1.5px solid var(--border);
            border-radius: 19px;
            min-width: 300px;
            max-width: 420px;
            flex: 1 1 320px;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            overflow: hidden;
            position: relative;
            height: 480px;
            box-shadow: 0 3px 14px 0 rgba(180,170,220,0.09);
            transition: box-shadow 0.2s;
            cursor: pointer;
        }
        .card[tabindex]:focus {
            outline: 3px solid var(--primary-dark);
        }
        .card-img {
            width:100%; height:150px;
            background: var(--gradient);
            display: flex; align-items:center; justify-content:center;font-size:4rem;
        }
        .fav { position:absolute;top:1rem;right:1rem; font-size:1.8rem; z-index:10;}
        .card-body {
            padding:1.1rem 1.2rem 1rem 1.2rem;
            flex:1 1 auto;
            display: flex; flex-direction: column;
        }
        .card-title { font-size:1.18rem; font-weight:800; margin-bottom:0.27rem; color:#743a7b;}
        .card-time { font-size: 1em; color: #9a4a1a; background:rgba(245,158,42,0.17); border-radius:7px; padding: 2px 10px; margin:0.21em 0 0.31em 0;}
        .tag {display:inline-block; padding:0.21rem 0.61rem; border-radius:6px; font-size:0.98em;font-weight:600;margin-right:0.23rem;margin-bottom:0.28rem;}
        .tag-type {background:#e3eafe; color:#284387; border: 1px solid #b3ccfa;}
        .tag-diet {background:#ffe9d4; color:#b45309; border: 1.2px solid #ffa36c;}
        .card-servings { font-size:1.08em; color:var(--accent);margin-bottom:0.17em;}
        .card-qtys { font-size:1.07em; color:#783e19;}
        .card-actions {
            margin-top:auto;
            width:100%;
            display:flex;align-items:center;justify-content:flex-start;gap:0.43em;
        }
        .planner-select select {
            border-radius: 8px;
            border: 1.3px solid var(--border);
            background: #faf8fc;
            color: #17263a;
            padding: 0.52em 0.8em;
            font-size: 1em;
            margin-right:0.26em;
            appearance: none;
            transition: box-shadow 0.2s, border 0.2s;
            box-shadow: 0 1px 4px 0 rgba(146,172,234,0.10);
        }
        .planner-select select:focus {
            outline: none;
            border-color: var(--primary-dark);
            box-shadow: 0 1px 8px 0 rgba(102,126,234,0.17);
            background: #e3eafe;
            color: #3a216d;
        }
        .planner-select .btn {
            background: linear-gradient(120deg,#f4b586 0%, #e37b38 100%);
            color: #fff;
            border:none;
            border-radius:8px;
            padding:0.58em 1.05em;
            font-weight:600;
            font-size:0.99em;
            margin-left:0.14em;
            cursor:pointer;
            box-shadow: 0 2px 8px 0 #e3eaf855;
            transition:background 0.22s;
        }
        .planner-select .btn:hover {
            background: linear-gradient(120deg,#e37b38 0%, #bdb4fc 100%);
        }
        .empty {text-align:center; padding:3rem 1rem; color:var(--text-dim);}
        .empty-icon {font-size:4rem; margin-bottom:1rem; opacity:0.4;}
        @media(max-width:950px){
            .grid {flex-direction:column;}
            .card {max-width:100%;min-width:0;}
        }
        /* Modal styles */
        .modal {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            background:rgba(0,0,0,0.55);
            z-index:1000;
            align-items: center; justify-content: center; padding: 1rem;
        }
        .modal.active { display: flex;}
        .modal-content {
            background: var(--card);
            border-radius: 22px;
            max-width:520px;
            width:98vw;
            min-height:320px;
            max-height:80vh;
            overflow-y:auto;
            box-shadow: 0 6px 26px #cfe8fc60;
        }
        .modal-header {
            padding:1.2rem 1.2rem 1.12rem 1.2rem;
            border-bottom:1.5px solid var(--border);
            display:flex; justify-content:space-between; align-items:flex-start;
        }
        .modal-title {
            font-size:1.28em;font-weight:800;background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;padding-right:1em;
        }
        .modal-close {
            background: none; border: none;
            font-size:2.06rem; font-weight:600;
            color:var(--primary-dark);
            cursor:pointer;
            border-radius:50%;
            width:2.13em; height:2.13em;
            transition: background 0.13s;
        }
        .modal-close:hover { background: var(--gradient); color: #fff;}
        .modal-body { padding:1.07rem 1.45rem;}
        .modal-footer {
            padding:1rem 1.35rem;
            border-top:1.2px solid var(--border);
            display:flex;justify-content:flex-end;
        }
        .modal-btn-close {
            background: linear-gradient(120deg,#f4b586 0%, #e37b38 100%);
            color: #fff;
            font-size:1.08em; font-weight:700;
            border:none; border-radius:8px;
            padding:0.69em 1.09em; cursor:pointer; margin:0.23em 0;
        }
        .modal-btn-close:hover { background: linear-gradient(120deg,#e37b38 30%, #bdb4fc 100%);}
        .modal-section-sub { color:var(--primary-dark);font-size:1.13em;font-weight:800;margin-top:1.3em;margin-bottom:0.32em;}
        .modal-ingredients-list {margin-left:0;margin-bottom:0.34em;}
        .modal-ingredients-list span {display:inline-block;padding:0.18em 0.4em;margin-right:0.13em;margin-bottom:0.1em;background:#f3efe3;color:#e37b38;border-radius:6px;font-weight:500;}
        /* Instructions */
        .modal-instructions { color: #1c3057; font-size:1.09em; margin-top:0.33em; margin-bottom:1.2em; line-height:1.7;}
        .modal-servings { font-size:1.07em; color:#e37b38; font-weight:700;}
    </style>
</head>
<body>
<nav class="nav" aria-label="Main navigation">
    <div class="nav-content">
        <div class="nav-brand">üè† Home Hub</div>
        <ul class="nav-menu" id="navMenu">
            <li><a href="../index.html">üìä Dashboard</a></li>
            <li><a href="meals.html" class="active">üçΩÔ∏è Meals</a></li>
            <li><a href="planner.html">üìÖ Planner</a></li>
            <li><a href="shopping.html">üõí Shopping</a></li>
            <li><a href="cleaning.html">üßπ Cleaning</a></li>
            <li><a href="maintenance.html">üõ†Ô∏è Maintenance</a></li>
            <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
        </ul>
    </div>
</nav>
<div class="container">
    <h1>Meals & Recipes</h1>
    <div class="top-controls">
        <button class="btn btn-primary" onclick="openModal('add')">‚ûï Add Recipe</button>
    </div>
    <div class="filters-bar">
        <label for="dietFilter">Diet:</label>
        <select id="dietFilter" onchange="filterMeals()">
            <option value="">All</option>
            <option value="meat">Meat</option>
            <option value="vegetarian">Vegetarian</option>
            <option value="vegan">Vegan</option>
            <option value="fish">Fish</option>
        </select>
        <label for="timeFilter">Meal Time:</label>
        <select id="timeFilter" onchange="filterMeals()">
            <option value="">All</option>
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
        </select>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none;">
        <div class="empty-icon">üçΩÔ∏è</div>
        <h3>No meals found</h3>
        <p>Add a recipe using the button above.</p>
    </div>
</div>
<!-- Manual Add Meal Modal -->
<div class="modal" id="addModal" role="dialog" aria-modal="true" aria-labelledby="addMealTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="addMealTitle" class="modal-title">Add Recipe</h2>
            <button class="modal-close" onclick="closeModal('add')" aria-label="Close">&times;</button>
        </div>
        <form id="addForm" onsubmit="saveRecipe(event)">
        <div class="modal-body">
            <div class="form-group">
                <label for="title">Title</label>
                <input type="text" id="title" required aria-required="true">
            </div>
            <div class="form-group modal-group-row">
                <div>
                    <label for="type">Meal Type</label>
                    <select id="type" required aria-required="true">
                        <option value="">Select type</option>
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                    </select>
                </div>
                <div>
                    <label for="diet">Dietary requirements</label>
                    <select id="diet" multiple aria-label="Select dietary requirements">
                        <option value="meat">Meat</option>
                        <option value="vegetarian">Vegetarian</option>
                        <option value="vegan">Vegan</option>
                        <option value="fish">Fish</option>
                    </select>
                </div>
            </div>
            <div class="form-group">
                <label for="ingredients">Ingredients & Amounts (e.g. "2 eggs, 125g flour, 200ml milk")</label>
                <textarea id="ingredients" required aria-required="true"></textarea>
                <small>Ingredient units accepted: g, kg, ml, l, quantity (use e.g. "2 eggs" for quantity).</small>
            </div>
            <div class="form-group">
                <label for="instructions">Method / Instructions</label>
                <textarea id="instructions" required aria-required="true"></textarea>
            </div>
            <div class="form-group modal-group-row">
                <div>
                    <label for="servings">Servings (adults)</label>
                    <input type="number" id="servings" min="1" value="4" required aria-required="true">
                </div>
                <div>
                    <label for="urlInput">Recipe URL (optional)</label>
                    <input type="url" id="urlInput" placeholder="e.g. https://www.bbcgoodfood.com/recipes/slow-cooker-ratatouille">
                </div>
            </div>
            <div class="form-group">
                <label for="photoInput">Optional Recipe Photo</label>
                <input type="file" id="photoInput" accept="image/*" onchange="previewPhoto(event)">
                <div class="meal-photo-preview" id="photoPreview"></div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="modal-btn-close" type="submit">Save Recipe</button>
            <button class="modal-btn-close" type="button" onclick="closeModal('add')">Cancel</button>
        </div>
        </form>
    </div>
</div>
<!-- Meal View Modal -->
<div class="modal" id="viewModal" role="dialog" aria-modal="true" aria-labelledby="mealDetailsTitle">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="mealDetailsTitle" class="modal-title"></h2>
            <button class="modal-close" onclick="closeModal('view')" aria-label="Close">&times;</button>
        </div>
        <div class="modal-body" id="viewBody"></div>
        <div class="modal-footer">
            <button class="modal-btn-close" onclick="closeModal('view')">Close</button>
        </div>
    </div>
</div>
<script>
const LS_KEY = 'hubMeals';
let MEALS = JSON.parse(localStorage.getItem(LS_KEY)||"[]");
let photoDataUrl = '';
function previewPhoto(event){
    const file = event.target.files[0];
    if(!file) {photoDataUrl='';document.getElementById("photoPreview").innerHTML="";return;}
    const reader = new FileReader();
    reader.onload = function(e){
        photoDataUrl = e.target.result;
        document.getElementById("photoPreview").innerHTML = `<img src="${photoDataUrl}" alt="Recipe image preview">`;
    };
    reader.readAsDataURL(file);
}
function openModal(id){ document.getElementById(id+'Modal').classList.add('active'); }
function closeModal(id){
    document.getElementById(id+'Modal').classList.remove('active');
    if(id==='add'){
        document.getElementById('addForm').reset();
        document.getElementById('photoPreview').innerHTML='';
        photoDataUrl='';
    }
}
function filterMeals(){
    renderGrid();
}
function getFilters(){
    return {
        diet: document.getElementById("dietFilter").value,
        time: document.getElementById("timeFilter").value
    };
}
function renderGrid(){
    const grid=document.getElementById('grid');
    const empty=document.getElementById('empty');
    const {diet, time} = getFilters();
    let mealsFiltered = MEALS.filter(m=>{
        let dietMatch = !diet || (m.diet && m.diet.includes(diet));
        let timeMatch = !time || (m.type && m.type.toLowerCase()==time);
        return dietMatch && timeMatch;
    });
    grid.innerHTML = '';
    if(mealsFiltered.length===0){
        grid.style.display='none';
        empty.style.display='block';
    }else{
        grid.style.display='flex';
        empty.style.display='none';
        grid.innerHTML =
        mealsFiltered.map((m,idx)=>{
            let servingsFront = `<div class="card-servings">Serves: 4 adults</div>`;
            let qtysView = m.ing && m.ing.length ? m.ing.map(i=>`<span>${ingredientQtyString(i, m.servings)}</span>`).join(', ') : '';
            let photo = m.photo ? `<img src="${m.photo}" alt="${escapeHTML(m.title)} recipe photo">` : m.emoji||'üçΩÔ∏è';
            let dietaryView = m.diet && m.diet.length ? m.diet.map(d=>`<span class="tag tag-diet">${escapeHTML(d.replace('-',' '))}</span>`).join(''):"";
            let mealTime = m.type
                ? `<span class="tag tag-type">${escapeHTML((m.type||"").charAt(0).toUpperCase()+((m.type||"").slice(1)))} </span>`
                : '';
            let timeEstimate = typeof m.time === 'number'
                ? Math.ceil(m.time/10)*10
                : estimateMealTime(m.ing);
            let cardTimeView = `<span class="card-time">Estimated time: ${timeEstimate} mins</span>`;
            let plannerPanel = `
                <div class="card-actions planner-select" onclick="event.stopPropagation()">
                    <select id="plannerDay${idx}" aria-label="Choose day">
                        <option value="">Day...</option>
                        <option>Sunday</option>
                        <option>Monday</option>
                        <option>Tuesday</option>
                        <option>Wednesday</option>
                        <option>Thursday</option>
                        <option>Friday</option>
                        <option>Saturday</option>
                    </select>
                    <select id="plannerTime${idx}" aria-label="Choose meal time">
                        <option value="">Time...</option>
                        <option>Breakfast</option>
                        <option>Lunch</option>
                        <option>Dinner</option>
                        <option>Snack</option>
                    </select>
                    <button class="btn" onclick="addMealToPlannerDirect(${MEALS.indexOf(m)}, ${idx});event.stopPropagation()">Add to Planner</button>
                </div>
            `;
            return `
            <div class="card" tabindex="0" aria-label="View details for ${escapeHTML(m.title)}" onclick="viewMeal(${MEALS.indexOf(m)})">
                <div class="card-img">${photo}</div>
                <div class="card-body">
                    <div class="card-title">${escapeHTML(m.title)}</div>
                    ${cardTimeView}
                    ${mealTime} ${dietaryView}
                    ${servingsFront}
                    <div class="card-qtys">Ingredients: ${qtysView}</div>
                    ${plannerPanel}
                </div>
            </div>
        `}).join('');
    }
}
function ingredientQtyString(ingredient, servings=1){
    // Fix common split spelling and stray spaces in ingredients (e.g. "egg s", "baco n", "sausag e", "tomat o")
    let cleaned = ingredient
        .replace(/\b([a-zA-Z]+)\s([a-zA-Z])\b/g, '$1$2')
        .replace(/\begg s\b/gi, "eggs")
        .replace(/\bbaco n\b/gi, "bacon")
        .replace(/\bsausag e\b/gi, "sausage")
        .replace(/\btomat o\b/gi, "tomato")
        .replace(/\bmushroo m\b/gi, "mushroom")
        .replace(/\bchil i\b/gi, "chili")
        .replace(/\bchoc olate\b/gi, "chocolate")
        .replace(/\bonio n\b/gi, "onion")
        ;
    // Parse quantity and unit
    let match = cleaned.match(/^(\d+(?:\.\d+)?)\s*([a-zA-Z]+)?\s*(.+)/);
    if(match){
        let qty = match[1], unit = match[2]||"", rest = match[3];
        let perAdult = Math.ceil(parseFloat(qty) * 4 / (servings||1));
        if (!isNaN(perAdult) && perAdult > 0) qty = perAdult.toString();
        return `${qty} ${unit} ${rest}`.replace(/\s+/g,' ').trim();
    }
    // If just a word, show 4x quantity for adults
    return /^([a-zA-Z ]+)$/.test(cleaned) ? `4 ${cleaned}` : cleaned;
}
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g,
        function(m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function estimateMealTime(ingredients) {
    let timeTotal = 0;
    if (!ingredients) return 10;
    ingredients.forEach(line => {
        let lc = line.toLowerCase();
        let match = lc.match(/(\d+(?:\.\d+)?)\s*(g|kg|ml|l|egg|eggs|cup|tbsp|tsp)?\s*(.+)/);
        timeTotal += 5;
        if (lc.includes("chicken") || lc.includes("lamb") || lc.includes("beef") || lc.includes("pork")) timeTotal += 10;
        if (lc.includes("oven") || lc.includes("roast") || lc.includes("boil")) timeTotal += 10;
    });
    return Math.ceil(timeTotal/10)*10;
}
function addMealToPlannerDirect(mealIdx, idx){
    const day = document.getElementById(`plannerDay${idx}`).value;
    const time = document.getElementById(`plannerTime${idx}`).value;
    if(!day || !time){ alert("Please select Day & Time for meal planner"); return; }
    let planner = JSON.parse(localStorage.getItem('hubPlanner')||'[]');
    while(planner.length < 7){ planner.push({slots:{}});}
    let dayIdx = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"].indexOf(day);
    if(dayIdx<0) return;
    if(!planner[dayIdx].slots) planner[dayIdx].slots={};
    planner[dayIdx].slots[time] = {...MEALS[mealIdx]};
    localStorage.setItem('hubPlanner', JSON.stringify(planner));
    alert(`Added "${MEALS[mealIdx].title}" to planner for ${day} / ${time}`);
}
function viewMeal(idx){
    let m = MEALS[idx];
    let servings = 4; // Always display 4 adults, and calculate ingredients accordingly
    let timeEstimate = typeof m.time === 'number'
        ? Math.ceil(m.time/10)*10
        : estimateMealTime(m.ing);
    let dietaryView = m.diet && m.diet.length ? m.diet.map(d=>`<span class="tag tag-diet">${escapeHTML(d.replace('-',' '))}</span>`).join(''):"";
    let mealTime = m.type
        ? `<span class="tag tag-type">${escapeHTML((m.type||"").charAt(0).toUpperCase()+((m.type||"").slice(1)))} </span>`
        : '';
    let photo = m.photo ? `<img src="${m.photo}" alt="${escapeHTML(m.title)} recipe" style="width:100%;max-width:100%;max-height:140px;border-radius:7px;">` : m.emoji||'üçΩÔ∏è';
    let urlView = m.url ? `<div style="margin-top:.7em;font-size:.99em;"><a href="${escapeHTML(m.url)}" target="_blank">${escapeHTML(m.url)}</a></div>` : '';
    let qtysList = m.ing && m.ing.length ?
        m.ing.map(i=>`<span>${ingredientQtyString(i, m.servings)}</span>`).join(' ') : '<span style="color:#c2b7af;">No ingredients listed.</span>';

    document.getElementById("mealDetailsTitle").innerHTML = escapeHTML(m.title);

    document.getElementById("viewBody").innerHTML = `
        <div style="text-align:center; font-size:2em; margin-bottom:0.34em;">${photo}</div>
        <div style="margin-bottom:0.9em;">${mealTime} ${dietaryView}</div>
        <div class="card-time" style="margin-bottom:0.6em; color:#a05718;">Estimated time: ${timeEstimate} mins</div>
        ${urlView}
        <div class="modal-section-sub">Ingredients and Quantities:</div>
        <div class="modal-ingredients-list">${qtysList}</div>
        <div class="modal-section-sub">Instructions:</div>
        <div class="modal-instructions">${m.instructions ? escapeHTML(m.instructions) : '<span style="color:#c2b7af;">No instructions listed.</span>'}</div>
        <div class="modal-servings">Servings: 4 adults</div>
    `;
}
function saveRecipe(event){
    event.preventDefault();
    let title = document.getElementById('title').value.trim();
    let type = document.getElementById('type').value;
    let dietArray = Array.from(document.getElementById('diet').selectedOptions).map(opt=>opt.value);
    let ingRaw = document.getElementById('ingredients').value.split(',').flatMap(s=>s.split('\n')).map(t=>t.trim()).filter(t=>t);
    let instructions = document.getElementById('instructions').value;
    let servings = 4; // always save as 4 adults for calculation
    let url = document.getElementById('urlInput').value.trim();
    let time = estimateMealTime(ingRaw);
    let photo = photoDataUrl || "";
    let meal = {
        id: "m"+Date.now()+Math.random().toString(16).slice(2),
        title,
        type,
        diet: dietArray,
        ing: ingRaw,
        instructions,
        servings,
        fav: false,
        emoji: "üçΩÔ∏è",
        url,
        time,
        photo
    };
    MEALS.push(meal);
    localStorage.setItem(LS_KEY, JSON.stringify(MEALS));
    closeModal('add');
    renderGrid();
    alert('Recipe saved!');
}
window.addEventListener('DOMContentLoaded',renderGrid);
</script>
</body>
</html>
