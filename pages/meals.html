<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Meals with Recipe Photo OCR | Home Hub</title>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5.0.1/dist/tesseract.min.js"></script>
    <!-- Your previous styles here -->
    <style>
        /* Paste your Home Hub meals styles here (from previous Meals code) */
        /* ... (omitted for brevity, keep the previous style block) ... */
        /* Below are some modal-specific tweaks */
        .ocr-status { margin-top: 1em; color: var(--primary); }
        .ocr-fields input, .ocr-fields textarea { width:100%; margin-bottom:0.75em; padding:0.5em;}
        .ocr-fields label { font-weight:600; margin-top:0.45em;}
        .equipment-list span { background:rgba(245,158,11,0.16); color:#b45309; border-radius:4px; padding:2px 8px; margin-right:6px;}
    </style>
</head>
<body>
<!-- Navigation bar (from your previous nav code) -->
<!-- ... (nav code unchanged; ensure correct paths for links) ... -->

<div class="container">
    <div class="header">
        <h1>Meals & Recipes</h1>
        <button class="btn btn-primary" onclick="openModal('add')">‚ûï Add Recipe</button>
        <input type="file" id="photoInput" accept="image/*" style="margin-left:2em;" onchange="handlePhotoUpload(event)">
        <button class="btn btn-secondary" onclick="document.getElementById('photoInput').click()">üì∑ Add Recipe from Photo</button>
    </div>
    <div class="grid" id="grid"></div>
    <div class="empty" id="empty" style="display:none;">
        <div class="empty-icon">üçΩÔ∏è</div>
        <h3>No meals found</h3>
        <p>Try adding a recipe or using the OCR photo upload above.</p>
    </div>
</div>
<div class="modal" id="ocrModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Extracted Recipe from Photo</h2>
            <button class="modal-close" onclick="closeModal('ocr')">&times;</button>
        </div>
        <form id="ocrForm" onsubmit="saveOcrRecipe(event)">
        <div class="modal-body ocr-fields">
            <label>Title</label>
            <input type="text" id="ocr_title" required>
            <label>Type</label>
            <select id="ocr_type" required>
                <option value="">Select</option>
                <option value="breakfast">Breakfast</option>
                <option value="lunch">Lunch</option>
                <option value="dinner">Dinner</option>
                <option value="snack">Snack</option>
            </select>
            <label>Ingredients (one per line)</label>
            <textarea id="ocr_ingredients" rows="5" required></textarea>
            <label>Equipment (one per line, optional)</label>
            <textarea id="ocr_equipment" rows="2"></textarea>
            <label>Instructions / Method</label>
            <textarea id="ocr_method" rows="7" required></textarea>
            <label>Number of portions</label>
            <input type="number" id="ocr_portions" min="1" value="1">
            <div id="ocrNutrition" style="margin:1em 0;"></div>
            <div id="ocrStatus" class="ocr-status"></div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" type="submit">Save to Meals</button>
            <button class="btn btn-secondary" type="button" onclick="calculateOcrNutrition()">Calculate Nutrition</button>
            <button class="btn" type="button" onclick="closeModal('ocr')">Cancel</button>
        </div>
        </form>
    </div>
</div>
<!-- Other recipe view/add modals (from your previous meals.html) -->
<script>
const MEALS = JSON.parse(localStorage.getItem('hubMeals')||"[]");

function openModal(id){ document.getElementById(id+'Modal').classList.add('active'); }
function closeModal(id){ document.getElementById(id+'Modal').classList.remove('active'); }
function renderGrid(){
    // ... (unchanged from your previous code, omit for brevity)
}

// OCR Photo Upload + Extraction
function handlePhotoUpload(event) {
    const file = event.target.files[0];
    if(!file) return;
    document.getElementById('ocrStatus').textContent = 'Scanning photo for recipe text...';
    openModal('ocr');
    Tesseract.recognize(file, 'eng').then(result =>{
        document.getElementById('ocrStatus').textContent = 'Scan complete! Parsing recipe...';
        const parsed = parseRecipeText(result.data.text);
        document.getElementById('ocr_title').value = parsed.title || '';
        document.getElementById('ocr_ingredients').value = parsed.ingredients.join('\n');
        document.getElementById('ocr_method').value = parsed.method || '';
        document.getElementById('ocr_equipment').value = parsed.equipment.join('\n');
        document.getElementById('ocr_type').value = parsed.type || '';
        document.getElementById('ocr_portions').value = parsed.portions || 1;
        document.getElementById('ocrStatus').textContent = '';
        // Focus first input
        document.getElementById('ocr_title').focus();
    }).catch(err=>{
        document.getElementById('ocrStatus').textContent = 'Scan failed: ' + err;
    });
}

// Heuristic text parser (improve as needed!)
function parseRecipeText(text) {
    let title = '';
    let type = '';
    let ingredients = [];
    let equipment = [];
    let method = '';
    let portions = 1;
    // Find title: first line, or up to "Ingredients"
    title = (text.match(/^(.+?)\n/)||[])[1] || '';
    // Find "Ingredients" section
    let ingMatch = text.match(/Ingredients([\s\S]*?)(?:Method|Instructions|Equipment|\n\n)/i);
    if(ingMatch) {
        ingredients = ingMatch[1].split('\n').map(l=>l.trim()).filter(l=>l && l.length<60);
    }
    // Find "Equipment" section
    let equipMatch = text.match(/Equipment([\s\S]*?)(?:Method|Instructions|\n\n)/i);
    if(equipMatch){
        equipment = equipMatch[1].split('\n').map(l=>l.trim()).filter(l=>l);
    }
    // Find "Method"/"Instructions"
    let methodMatch = text.match(/(?:Method|Instructions)([\s\S]*$)/i);
    if(methodMatch){
        method = methodMatch[1].replace(/\n{2,}/g,'\n').trim();
    }
    // Infer meal type from hints (try searching for "breakfast", "lunch", etc. in text)
    ['breakfast','lunch','dinner','snack'].forEach(t=>{
        if(new RegExp(t,'i').test(text) && !type) type = t;
    });
    // Look for "servings"/"portions"
    let servings = text.match(/(\d+)\s+(servings|portions)/i);
    if(servings) portions = Number(servings[1]);
    return { title, type, ingredients, equipment, method, portions };
}

// Save OCR'd recipe just like a normal meal
function saveOcrRecipe(event){
    event.preventDefault();
    const newMeal = {
        id: "m"+Date.now()+Math.random().toString(16).slice(2),
        title: document.getElementById('ocr_title').value.trim(),
        type: document.getElementById('ocr_type').value,
        ing: document.getElementById('ocr_ingredients').value.split('\n').filter(x=>x.trim()),
        equipment: document.getElementById('ocr_equipment').value.split('\n').filter(x=>x.trim()),
        instructions: document.getElementById('ocr_method').value,
        portions: parseInt(document.getElementById('ocr_portions').value)||1,
        fav: false,
        emoji: "üçΩÔ∏è"
    };
    MEALS.push(newMeal);
    localStorage.setItem('hubMeals', JSON.stringify(MEALS));
    closeModal('ocr');
    renderGrid();
    alert('Recipe saved!');
}

// Nutrition calculation (basic version)
function calculateOcrNutrition(){
    const ingList = document.getElementById('ocr_ingredients').value.split('\n').filter(x=>x.trim());
    const portions = parseInt(document.getElementById('ocr_portions').value)||1;
    document.getElementById('ocrNutrition').textContent = 'Calculating nutrition for ingredients...';
    // For free/offline, use a very basic nutrition lookup (just as example, real app would use USDA)
    const NUTRI_DB = {
        "chicken breast": {cal:165, protein:31, carb:0, fat:4},
        "egg": {cal:78, protein:6, carb:0.6, fat:5},
        "flour": {cal:364, protein:10, carb:76, fat:1}, // per 100g
        "milk": {cal:42, protein:3.4, carb:5, fat:1}, // per 100ml
        "butter": {cal:717, protein:1, carb:1, fat:81}, // per 100g
        "rice": {cal:130, protein:2.7, carb:28, fat:0.3}, // per 100g cooked
        // Add more common ingredients as needed...
    };
    // sum nutrients (very rough parsing for demo)
    let totals = {cal:0, protein:0, carb:0, fat:0};
    ingList.forEach(line=>{
        let lc = line.toLowerCase();
        let match = lc.match(/(\d+)\s*(g|ml|egg|eggs|cup|tbsp|tsp)?\s*(.+)/);
        let qty=1, unit="g", food="";
        if(match){
            qty = parseFloat(match[1]);
            unit = match[2]||"g";
            food = match[3].replace(/s$/,"");
        } else {
            food = lc.replace(/s$/,"");
        }
        // use NUTRI_DB if available
        let nutri = NUTRI_DB[food.trim()];
        if(nutri){
            // adjust for quantity/unit
            let adj = 1;
            if(unit=="g") adj = qty/100;
            if(unit=="ml") adj = qty/100;
            if(unit=="egg"||unit=="eggs") adj = qty;
            // Add to totals
            totals.cal += nutri.cal*adj;
            totals.protein += nutri.protein*adj;
            totals.carb += nutri.carb*adj;
            totals.fat += nutri.fat*adj;
        }
    });
    // Per portion
    document.getElementById('ocrNutrition').innerHTML = `
        <strong>Estimated nutrition per portion:</strong><br>
        Calories: ${Math.round(totals.cal/portions)} kcal<br>
        Protein: ${Math.round(totals.protein/portions)} g<br>
        Carbs: ${Math.round(totals.carb/portions)} g<br>
        Fat: ${Math.round(totals.fat/portions)} g<br>
        <span style="color:var(--text-dim);font-size:0.91em;">(for more accuracy, connect to USDA or Edamam API)</span>
    `;
}

window.addEventListener('DOMContentLoaded',renderGrid);
document.querySelectorAll('.modal').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('active')}));
document.addEventListener('keydown',e=>{if(e.key==='Escape')document.querySelectorAll('.modal').forEach(m=>m.classList.remove('active'))});
</script>
</body>
</html>
