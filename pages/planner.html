<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Meal Planner - Home Hub</title>
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #764ba2;
            --gradient: linear-gradient(120deg,#b0bbe9 0%, #fdb6b6 100%);
            --bg: #e9eef6;
            --card: #f7f7fb;
            --text: #25304b;
            --text-dim: #6a7fa7;
            --border: #dbe1ec;
            --accent: #e37b38;
            --tag: #fff8e8;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.61;
            min-height:100vh;
        }
        * { box-sizing: border-box; margin: 0; padding: 0;}
        .nav { background: #fcfcfc; border-bottom: 1px solid var(--border); padding: 1rem 1.5rem;}
        .nav-content { max-width: 1400px; margin: 0 auto; display: flex;justify-content: space-between; align-items: center;}
        .nav-brand { font-size: 1.5rem; font-weight: 800; background:var(--gradient);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
        .nav-menu {display:flex; gap:0.58rem; list-style:none;}
        .nav-menu a {padding:0.6rem 1.2rem; border-radius:8px; text-decoration:none; color:var(--text-dim); font-weight:600;font-size:0.97rem;}
        .nav-menu a:hover { background: rgba(102,126,234,0.15); color:var(--primary);}
        .nav-menu a.active { background: var(--gradient); color: white; }
        .container { max-width: 1400px; margin: 0 auto; padding: 2rem 1.5rem;}
        .header {
            display: flex; flex-wrap:wrap; justify-content: space-between; align-items: center; margin-bottom: 2rem; gap:1rem;
        }
        h1 {
            font-size:2.2rem;
            background:var(--gradient);
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
            margin:0 0 0.6em 0;
            letter-spacing: 0.02em;
            font-weight: 800;
        }
        .planner-action { display:flex; gap: 0.9rem; margin-bottom:2rem; }
        .btn {
            padding:0.81rem 1.5rem;
            border-radius:8px;
            font-weight:600;
            cursor:pointer;
            border:none;
            background: var(--gradient);
            color:#fff;
            font-size:1rem;
            box-shadow:0 1px 6px #e3eaf89a;
            transition:background 0.19s, color 0.16s;
        }
        .btn:hover{ background: linear-gradient(120deg, #dac8fc 0%, #c3f2ff 100%); color:#394368;}
        .btn-secondary{
            background:#e3eafe;
            color:#764ba2;
            border:1.5px solid var(--border);
        }
        .btn-secondary:hover{background:var(--gradient);color:#24213d;}
        /* Responsive grid */
        .planner-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
            margin-bottom:2rem;
        }
        @media(max-width:900px){
            .planner-grid { grid-template-columns:1fr; gap:1rem;}
        }
        .day-card {
            background:var(--card);
            border:1.5px solid var(--border);
            border-radius:17px;
            box-shadow: 0 2px 17px #cfe8fc2a;
            padding:1.36em 1.6em 1.2em 1.6em;
            min-width:240px; max-width:650px;
        }
        .day-label {
            font-size:1.25em; font-weight:800; color:#4474c7;
            margin-bottom:0.89em;
            letter-spacing:0.01em;
        }
        .meal-block { margin-bottom:1.25em; }
        .meal-header { font-weight:700; margin-bottom:0.18em; color:#25304b; font-size:1.08em;}
        .meal-cell-content { display:flex; align-items:center; gap:0.46em; margin-bottom:0.02em;}
        .meal-emoji { font-size:1.43em; margin-right:0.08em;}
        .meal-title { font-weight:700; color:#764ba2; margin-right:0.27em; font-size:1.1em;}
        .meal-type {font-size:0.98em; color:#576389; font-style:italic; background:#e3eafe; border-radius:3px; padding:0 0.38em;}
        .meal-diet {font-size:0.97em; color:#e37b38; background:#fff9ee; border-radius:3px; padding:0 0.37em; margin-left:0.22em;}
        .clear-link {color:#764ba2;cursor:pointer;font-size:0.97em;background:none;border:none;margin-left:0.8em;}
        .clear-link:hover{text-decoration:underline;}
        .meal-ingredients {
            font-size:1.05em;
            color:var(--accent);
            margin-left:2.1em;
            margin-top:0.07em;
            letter-spacing:0.04em;
            word-break:break-word;
        }
        /* Dropdown styling for select (non-corporate look) */
        .meal-select {
            width:100%; padding:0.58em 0.85em;
            border-radius:9px; border:1.5px solid var(--border);
            background: #f4f6fb;
            color: #273248;
            font-size:1.07em; font-weight:500;
            margin-bottom:0.22em;
            box-shadow:0 1px 5px #e3eaf841;
        }
        .meal-select:focus {
            border-color: #734b9a;
            outline:none;
            background:#e3eafe;
            color: #1e2541;
        }
        .empty { color: var(--text-dim); font-size:1.065rem; margin-top:2em; text-align:center;}
        @media(max-width:660px){
            .meal-block {font-size:1em;}
            .day-label {font-size:1.1em;}
            .planner-grid {padding-left:0;padding-right:0;}
            .day-card{min-width:0;padding:1em 0.6em;}
        }
    </style>
</head>
<body>
<nav class="nav" aria-label="Main navigation">
    <div class="nav-content">
        <div class="nav-brand">üè† Home Hub</div>
        <ul class="nav-menu" id="navMenu">
            <li><a href="../index.html">üìä Dashboard</a></li>
            <li><a href="meals.html">üçΩÔ∏è Meals</a></li>
            <li><a href="planner.html" class="active">üìÖ Planner</a></li>
            <li><a href="shopping.html">üõí Shopping</a></li>
            <li><a href="cleaning.html">üßπ Cleaning</a></li>
            <li><a href="maintenance.html">üõ†Ô∏è Maintenance</a></li>
            <li><a href="settings.html">‚öôÔ∏è Settings</a></li>
        </ul>
    </div>
</nav>
<div class="container">
    <div class="header">
        <h1>Weekly Meal Planner</h1>
        <div class="planner-action">
            <button class="btn" onclick="generateShoppingListFromPlanner()">Generate Shopping List</button>
            <a href="shopping.html"><button class="btn-secondary">Go To Shopping List</button></a>
        </div>
    </div>
    <div class="planner-grid" id="plannerGrid"></div>
    <div class="empty" id="emptyPlanner" style="display:none;">No meals planned this week. Add meals using the Meals page or select meals below.</div>
</div>
<script>
const WEEKDAYS = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const MEAL_TIMES = ["Breakfast", "Lunch", "Dinner", "Snack"];
const meals = JSON.parse(localStorage.getItem('hubMeals')||'[]');
function getMealOptions(mt){
    return meals.map(m=>
        `<option value="${m.id}">${m.emoji ? m.emoji+" " : ""}${m.title} (${m.type||mt})</option>`
    ).join('');
}
function loadPlanner(){
    let planner = JSON.parse(localStorage.getItem('hubPlanner')||'[]');
    while(planner.length<7){ planner.push({slots:{}});}
    for(let i=0;i<7;i++){
        if(!planner[i].slots) planner[i].slots={};
    }
    return planner;
}
function savePlanner(planner){ localStorage.setItem('hubPlanner', JSON.stringify(planner)); }
function escapeHTML(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g,
        function(m) { return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]; });
}
function ingredientQtyString(ingredient, servings=1){
    let cleaned = ingredient
        .replace(/\b([a-zA-Z]+)\s([a-zA-Z])\b/g, '$1$2')
        .replace(/\begg s\b/gi, "eggs")
        .replace(/\bbaco n\b/gi, "bacon")
        .replace(/\bsausag e\b/gi, "sausage")
        .replace(/\btomat o\b/gi, "tomato")
        .replace(/\bmushroo m\b/gi, "mushroom")
        .replace(/\bchil i\b/gi, "chili")
        .replace(/\bchoc olate\b/gi, "chocolate")
        .replace(/\bonio n\b/gi, "onion");
    let match = cleaned.match(/^(\d+(?:\.\d+)?)\s*([a-zA-Z]+)?\s*(.+)/);
    if(match){
        let qty = match[1], unit = match[2]||"", rest = match[3];
        let perAdult = Math.ceil(parseFloat(qty) * 4 / (servings||1));
        if (!isNaN(perAdult) && perAdult > 0) qty = perAdult.toString();
        return `${qty} ${unit} ${rest}`.replace(/\s+/g,' ').trim();
    }
    return /^([a-zA-Z ]+)$/.test(cleaned) ? `4 ${cleaned}` : cleaned;
}
function renderPlanner(){
    let planner = loadPlanner();
    let isEmpty = true;
    let gridHTML = '';
    for(let i=0;i<7;i++){
        let slot = planner[i].slots;
        let blocks = '';
        MEAL_TIMES.forEach(mt=>{
            let mealObj = slot[mt] ? meals.find(m=>m.id === slot[mt].id) || slot[mt] : null;
            let mealCell = '';
            if(mealObj && mealObj.title){
                isEmpty = false;
                let qtysText = mealObj.ing && mealObj.ing.length ?
                  mealObj.ing.map(x=>ingredientQtyString(x, mealObj.servings)).join(', ') :
                  '';
                mealCell = `
                <div class="meal-cell-content">
                    <span class="meal-emoji">${escapeHTML(mealObj.emoji||"")}</span>
                    <span class="meal-title">${escapeHTML(mealObj.title)}</span>
                    <span class="meal-type">${mt.toLowerCase()}</span>
                    ${mealObj.diet && mealObj.diet.length ? `<span class="meal-diet">${escapeHTML(mealObj.diet.join(', '))}</span>` :''}
                    <button class="clear-link" onclick="clearMeal(event, ${i}, '${mt}')">Clear</button>
                </div>
                <div class="meal-ingredients">${qtysText}</div>
                `;
            } else {
                mealCell = `
                    <select class="meal-select" onchange="setMeal(${i},'${mt}',this.value)">
                        <option value="">Select ${mt}</option>${getMealOptions(mt)}
                    </select>
                `;
            }
            blocks += `<div class="meal-block">
                <span class="meal-header">${mt}:</span><br>${mealCell}
            </div>`;
        });
        gridHTML += `
        <div class="day-card">
            <div class="day-label">${WEEKDAYS[i]}</div>
            <div>${blocks}</div>
        </div>
        `;
    }
    document.getElementById('plannerGrid').innerHTML = gridHTML;
    document.getElementById('emptyPlanner').style.display = isEmpty ? "block":"none";
    let plannerData = loadPlanner();
    let selects = document.querySelectorAll('.meal-select');
    selects.forEach((s,idx) => {
        let day = Math.floor(idx/MEAL_TIMES.length);
        let time = MEAL_TIMES[idx%MEAL_TIMES.length];
        let id = plannerData[day] && plannerData[day].slots[time] && plannerData[day].slots[time].id ? plannerData[day].slots[time].id : "";
        s.value = id;
    });
}
function setMeal(day, mt, mealId){
    let planner = loadPlanner();
    let mealObj = meals.find(m=>m.id === mealId);
    if(!planner[day].slots) planner[day].slots={};
    planner[day].slots[mt] = mealObj ? {...mealObj} : null;
    savePlanner(planner);
    renderPlanner();
}
function clearMeal(event, day, mt){
    event.stopPropagation();
    let planner = loadPlanner();
    if(!planner[day].slots) planner[day].slots={};
    planner[day].slots[mt] = null;
    savePlanner(planner);
    renderPlanner();
}
function generateShoppingListFromPlanner() {
    let planner = loadPlanner();
    let weekIngredients = [];
    planner.forEach(slotObj=>{
        Object.values(slotObj.slots||{}).forEach(meal=>{
            if(meal && meal.ing){
                weekIngredients.push(...meal.ing);
            }
        });
    });
    function parseIngredient(ingredient) {
        let parts = ingredient.trim().split(" ");
        if (parts.length>=2 && !isNaN(parts[0])) {
            return {name:parts.slice(1).join(" "), qty:Number(parts[0])};
        }
        return {name:ingredient.trim(), qty:1};
    }
    let merged = {};
    weekIngredients.forEach(i => {
        let {name, qty} = parseIngredient(i);
        let key = name.toLowerCase();
        if(name=='') return;
        if(merged[key]) merged[key].qty += qty;
        else merged[key]={name, qty};
    });
    let shopping = JSON.parse(localStorage.getItem('hubShopping')||'[]');
    Object.values(merged).forEach(({name,qty}) => {
        let idx = shopping.findIndex(i=>i.name.toLowerCase()===name.toLowerCase());
        if(idx>=0) {
            shopping[idx].qty = (shopping[idx].qty||1)+qty;
        } else {
            shopping.push({name, qty, fav:false, checked:false});
        }
    });
    localStorage.setItem('hubShopping', JSON.stringify(shopping));
    alert("Weekly meals added to shopping list!");
}
window.addEventListener('DOMContentLoaded', renderPlanner);
</script>
</body>
</html>
